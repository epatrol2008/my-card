<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>SurveyFlow ‚Äî –û–ø—Ä–æ—Å—ã —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π</title>
  <meta name="description" content="–°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –æ–ø—Ä–æ—Å–æ–≤ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π: Google, Email/Password. (Telegram –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω —á–µ—Ä–µ–∑ backend –±–µ–∑ document.write)" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020;--card:#111a37;--muted:#9aa6d1;--text:#eaf0ff;--primary:#7aa2ff;--accent:#a78bfa;--stroke:rgba(255,255,255,.12);--r:16px;
      --pad:clamp(14px,2.5vw,22px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;line-height:1.55;color:var(--text);
      background:radial-gradient(900px 400px at 110% -10%,#2a135f,transparent 60%),
                 radial-gradient(700px 360px at -20% -10%,#193b7a,transparent 60%),
                 linear-gradient(#0b1020,#0a0f1f);
      -webkit-tap-highlight-color: transparent;
    }
    a{color:var(--primary);text-decoration:none}
    .container{max-width:1100px;margin:0 auto;padding:var(--pad)}
    header{position:sticky;top:0;z-index:10;background:rgba(8,12,28,.6);backdrop-filter:blur(8px);border-bottom:1px solid var(--stroke)}
    nav{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;font-size:clamp(14px,2.5vw,18px)}
    .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,#60a5fa,#a78bfa);box-shadow:0 0 12px #60a5fa99}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);cursor:pointer;font-size:14px}
    .tab.active{border-color:#8daaff;background:rgba(125,170,255,.18)}
    .grid{display:grid;gap:16px}
    .two{grid-template-columns:1fr 1fr}
    @media (max-width:860px){.two{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:var(--r);padding:var(--pad);box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .h{margin:0 0 8px;font-size:clamp(18px,2.6vw,22px)}
    .muted{color:var(--muted);font-size:clamp(12px,2vw,14px)}
    .input,select,textarea{width:100%;padding:12px;border:1px solid var(--stroke);border-radius:14px;background:#0c1430;color:var(--text);font-size:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{display:flex;justify-content:flex-end}
    .btn{padding:12px 14px;border-radius:14px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:var(--text);cursor:pointer;touch-action:manipulation}
    .btn.primary{background:linear-gradient(180deg,rgba(125,170,255,.25),rgba(125,170,255,.15));border-color:#8daaff}
    .btn.subtle{background:transparent}
    .btn.block{width:100%}
    .pill{display:inline-block;padding:6px 10px;border:1px solid var(--stroke);border-radius:999px;color:var(--muted);font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid var(--stroke);text-align:left;vertical-align:top}
    .kbd{display:inline-flex;padding:4px 8px;border:1px solid var(--stroke);border-radius:10px;background:rgba(255,255,255,.06);font-family:ui-monospace,monospace}
    .hide{display:none}
    button{min-height:44px}
  </style>
</head>
<body>
<header>
  <div class="container">
    <nav>
      <div class="brand"><span class="dot"></span> SurveyFlow</div>
      <div class="tabs">
        <button class="tab" data-tab="create">–°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å</button>
        <button class="tab" data-tab="take">–ü—Ä–æ–π—Ç–∏</button>
        <button class="tab" data-tab="results">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
      </div>
      <div class="row" style="gap:8px">
        <span id="userInfo" class="muted">–ì–æ—Å—Ç—å</span>
        <button id="googleBtn" class="btn">Google</button>
        <button id="emailLoginBtn" class="btn subtle">Email</button>
        <button id="emailRegisterBtn" class="btn subtle">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button id="resetBtn" class="btn subtle">–°–±—Ä–æ—Å</button>
        <button id="tgBtn" class="btn">Telegram</button>
        <button id="logoutBtn" class="btn subtle hide">–í—ã–π—Ç–∏</button>
      </div>
    </nav>
  </div>
</header>

<main class="container">
  <section id="create" class="grid">
    <div class="card">
      <h2 class="h">01 –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø—Ä–æ—Å–∞</h2>
      <div class="grid two">
        <div>
          <div class="muted">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
          <input id="sTitle" class="input" value="–ù–æ–≤—ã–π –æ–ø—Ä–æ—Å" />
        </div>
        <div>
          <div class="muted">–û–ø–∏—Å–∞–Ω–∏–µ</div>
          <input id="sDesc" class="input" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ" />
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 class="h">–í–æ–ø—Ä–æ—Å—ã</h2>
          <div class="muted">–¢–∏–ø—ã: –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç, —á–∏—Å–ª–æ, –æ–¥–∏–Ω –≤–∞—Ä–∏–∞–Ω—Ç, –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä</div>
        </div>
        <button id="addQ" class="btn">+ –î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>
      </div>
      <div id="questions" class="grid"></div>
    </div>

    <div class="row">
      <button id="saveSurvey" class="btn primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤—ã–¥–∞—Ç—å –∫–æ–¥</button>
      <div id="createdBlock" class="row hide">
        <span class="pill">–ö–æ–¥: <span id="codeOut" class="kbd" style="margin-left:6px"></span></span>
        <button id="copyLink" class="btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      </div>
    </div>
  </section>

  <section id="take" class="grid hide">
    <div class="card">
      <h2 class="h">–ü—Ä–æ–π—Ç–∏ –æ–ø—Ä–æ—Å</h2>
      <div class="grid two">
        <div>
          <div class="muted">–ö–æ–¥ –æ–ø—Ä–æ—Å–∞</div>
          <input id="takeCode" class="input" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 7F3A9C" />
        </div>
        <div class="right" style="align-items:end">
          <button id="loadSurvey" class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <div id="takeFormWrap" class="card hide"></div>
  </section>

  <section id="results" class="grid hide">
    <div class="card">
      <h2 class="h">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
      <div class="grid two">
        <div>
          <div class="muted">–ö–æ–¥ –æ–ø—Ä–æ—Å–∞</div>
          <input id="resCode" class="input" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 7F3A9C" />
        </div>
        <div class="right" style="align-items:end">
          <button id="loadResults" class="btn">–û—Ç–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>

    <div id="resTableWrap" class="card hide"></div>
  </section>

  <section id="debug" class="grid hide">
    <div class="card">
      <h2 class="h">Debug / –¢–µ—Å—Ç—ã</h2>
      <div class="row">
        <button id="dbgMakeDemo" class="btn">–°–æ–∑–¥–∞—Ç—å –¥–µ–º–æ‚Äë–æ–ø—Ä–æ—Å</button>
        <button id="dbgAddAnswers" class="btn">–î–æ–±–∞–≤–∏—Ç—å –¥–µ–º–æ‚Äë–æ—Ç–≤–µ—Ç—ã</button>
        <button id="dbgOpenResults" class="btn">–û—Ç–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã DEMO01</button>
      </div>
      <div class="muted" style="margin-top:8px">–≠—Ç–∏ –∫–Ω–æ–ø–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –ø—Ä–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ URL <span class="kbd">?debug=1</span>. –û–Ω–∏ —Å–æ–∑–¥–∞—é—Ç –æ–ø—Ä–æ—Å <span class="kbd">DEMO01</span>, –¥–æ–±–∞–≤–ª—è—é—Ç 2 –æ—Ç–≤–µ—Ç–∞ –∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —ç–∫—Å–ø–æ—Ä—Ç CSV.</div>
    </div>
  </section>
</main>

<!-- Telegram –≤–∏–¥–∂–µ—Ç —É–¥–∞–ª—ë–Ω –∏–∑ —Ä–∞–∑–º–µ—Ç–∫–∏, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å document.write -->

<script type="module">
  // ===== DIAGNOSTICS =====
  console.log('[SurveyFlow] boot start');
  const errBanner = (msg)=>{
    let b = document.getElementById('errBanner');
    if(!b){
      b = document.createElement('div');
      b.id='errBanner';
      b.style.cssText='position:fixed;left:0;right:0;bottom:0;background:#8b1d1d;color:#fff;padding:10px 14px;z-index:9999;font:14px/1.4 Inter,system-ui;';
      document.body.appendChild(b);
    }
    b.textContent = '–û—à–∏–±–∫–∞: ' + msg;
  };

  // –î–µ–ª–µ–≥–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π ‚Äî –±–æ–ª–µ–µ —É—Å—Ç–æ–π—á–∏–≤–∞
  const on = (type, sel, fn) => document.addEventListener(type, e=>{
    const el = e.target.closest(sel);
    if(el) fn(e, el);
  });

  // ===== FIREBASE (–º–æ–¥—É–ª—å–Ω—ã–π SDK) =====
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
  import {
    getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithRedirect, signOut,
    createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail
  } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

  const firebaseConfig = {
    apiKey: 'AIzaSyB3uq1X2iVJFk3RdcIl3DIpnjm3y3nUVEw',
    authDomain: 'surveyflow-129a6.firebaseapp.com',
    projectId: 'surveyflow-129a6',
    storageBucket: 'surveyflow-129a6.firebasestorage.app',
    messagingSenderId: '533639417218',
    appId: '1:533639417218:web:4cbd520e4b04250464539b'
  };

  let app, auth;
  try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    console.log('[SurveyFlow] firebase initialized');
  } catch (e) {
    console.error(e); errBanner('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase: '+e.message);
  }

  const googleProvider = new GoogleAuthProvider();

  // ===== AUTH BUTTONS =====
  on('click', '#googleBtn', async (e)=>{
    e.preventDefault();
    try { await signInWithPopup(auth, googleProvider); }
    catch(err){
      if (err.code==='auth/popup-blocked'||err.code==='auth/popup-closed-by-user') await signInWithRedirect(auth, googleProvider);
      else errBanner(err.message);
    }
  });

  on('click', '#emailLoginBtn', async (e)=>{
    e.preventDefault();
    const email = prompt('Email:');
    const pass = prompt('–ü–∞—Ä–æ–ª—å:');
    if(!email||!pass) return;
    try { await signInWithEmailAndPassword(auth, email.trim(), pass); }
    catch(err){ errBanner(err.message); }
  });

  on('click', '#emailRegisterBtn', async (e)=>{
    e.preventDefault();
    const email = prompt('Email (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è):');
    const pass = prompt('–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤):');
    if(!email||!pass) return;
    try { await createUserWithEmailAndPassword(auth, email.trim(), pass); alert('–ì–æ—Ç–æ–≤–æ! –í—ã –≤–æ—à–ª–∏.'); }
    catch(err){ errBanner(err.message); }
  });

  on('click', '#resetBtn', async (e)=>{
    e.preventDefault();
    const email = prompt('Email –¥–ª—è —Å–±—Ä–æ—Å–∞:');
    if(!email) return;
    try { await sendPasswordResetEmail(auth, email.trim()); alert('–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.'); }
    catch(err){ errBanner(err.message); }
  });

  // ===== TELEGRAM PLACEHOLDER =====
  on('click', '#tgBtn', (e)=>{
    e.preventDefault();
    alert('–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram –±—É–¥–µ—Ç –≤–∫–ª—é—á—ë–Ω –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è backend (Firebase Functions). –°–µ–π—á–∞—Å –æ—Ç–∫–ª—é—á–µ–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É document.write.');
  });

  // ===== UI STATE =====
  const userInfo = document.getElementById('userInfo');
  const logoutBtn = document.getElementById('logoutBtn');
  onAuthStateChanged(auth, (user)=>{
    if(user){ userInfo.textContent = user.displayName || user.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'; logoutBtn.classList.remove('hide'); }
    else { userInfo.textContent = '–ì–æ—Å—Ç—å'; logoutBtn.classList.add('hide'); }
  });
  on('click', '#logoutBtn', async (e)=>{ e.preventDefault(); await signOut(auth); });

  // ===== ROUTER =====
  const sections = { create: document.getElementById('create'), take: document.getElementById('take'), results: document.getElementById('results'), debug: document.getElementById('debug') };
  const tabs = [...document.querySelectorAll('.tab')];
  const takeCode = document.getElementById('takeCode');
  const resCode = document.getElementById('resCode');
  const url = new URL(location.href);
  const dbg = url.searchParams.get('debug')==='1';
  if(dbg){ sections.debug.classList.remove('hide'); }

  const setTab = (name) => {
    for (const k in sections) if(sections[k]) sections[k].classList.toggle('hide', k!==name);
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab===name));
    const qs = name==='take' && takeCode.value ? `?take=${takeCode.value}` : name==='results' && resCode.value ? `?results=${resCode.value}` : (dbg? '?debug=1' : '');
    history.replaceState({}, '', location.pathname + qs);
    window.scrollTo({ top:0, behavior:'smooth' });
  };
  on('click', '.tab', (e, el)=> setTab(el.dataset.tab));

  // ===== STORAGE (demo: LocalStorage) =====
  const LS_SURVEYS = 'surveys_v1';
  const LS_RESP = 'survey_responses_v1';
  const load = (k, f) => { try{ const r = localStorage.getItem(k); return r?JSON.parse(r):f; } catch{ return f; } };
  const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
  const uid = () => Math.random().toString(36).slice(2,8);
  const codeGen = () => Math.random().toString(36).slice(2,8).toUpperCase();

  let surveys = load(LS_SURVEYS, {});
  let responses = load(LS_RESP, {});

  // ===== BUILDER =====
  const qWrap = document.getElementById('questions');
  const sTitle = document.getElementById('sTitle');
  const sDesc = document.getElementById('sDesc');
  const createdBlock = document.getElementById('createdBlock');
  const codeOut = document.getElementById('codeOut');
  const copyLink = document.getElementById('copyLink');

  const TYPES = [
    {id:'short_text', label:'–ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç'},
    {id:'number', label:'–ß–∏—Å–ª–æ'},
    {id:'single', label:'–í—ã–±–æ—Ä –æ–¥–Ω–æ–≥–æ'},
    {id:'multi', label:'–ú—É–ª—å—Ç–∏–≤—ã–±–æ—Ä'}
  ];

  const state = { questions: [] };
  function renderQuestions(){
    qWrap.innerHTML = '';
    state.questions.forEach((q, idx) => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div class="muted">–í–æ–ø—Ä–æ—Å #${idx+1}</div>
          <div class="row">
            <label class="muted" style="display:flex;align-items:center;gap:6px">
              <input type="checkbox" ${q.required?'checked':''} data-act="req"/>
              –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π
            </label>
            <button class="btn subtle" data-act="del">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
        <div class="grid two" style="margin-top:10px">
          <input class="input" data-act="text" value="${q.text}" />
          <select class="input" data-act="type">${TYPES.map(t=>`<option value="${t.id}" ${t.id===q.type?'selected':''}>${t.label}</option>`).join('')}</select>
        </div>
        <div data-box="options" class="grid" style="margin-top:10px"></div>`;

      const box = card.querySelector('[data-box="options"]');
      const refreshOpts = () => {
        box.innerHTML = '';
        if(q.type==='single' || q.type==='multi'){
          (q.options||[]).forEach((opt,i)=>{
            const row = document.createElement('div');
            row.className = 'row';
            row.innerHTML = `<input class="input" value="${opt}"><button class="btn subtle">‚àí</button>`;
            row.lastChild.onclick = ()=>{ q.options.splice(i,1); refreshOpts(); };
            row.firstChild.oninput = (e)=>{ q.options[i] = e.target.value; };
            box.appendChild(row);
          });
          const add = document.createElement('button');
          add.className='btn'; add.textContent='+ –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç';
          add.onclick = ()=>{ q.options = q.options||[]; q.options.push('–í–∞—Ä–∏–∞–Ω—Ç '+((q.options.length||0)+1)); refreshOpts(); };
          box.appendChild(add);
        }
      };
      refreshOpts();

      card.querySelector('[data-act="req"]').onchange = e => q.required = e.target.checked;
      card.querySelector('[data-act="del"]').onclick = () => { state.questions.splice(idx,1); renderQuestions(); };
      card.querySelector('[data-act="text"]').oninput = e => q.text = e.target.value;
      card.querySelector('[data-act="type"]').onchange = e => { q.type = e.target.value; refreshOpts(); };
      qWrap.appendChild(card);
    });
  }

  on('click', '#addQ', (e)=>{ e.preventDefault(); state.questions.push({id:uid(), type:'short_text', text:'–í–æ–ø—Ä–æ—Å', required:true, options:['–í–∞—Ä–∏–∞–Ω—Ç 1','–í–∞—Ä–∏–∞–Ω—Ç 2']}); renderQuestions(); });
  // —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –ø–æ–ª–µ
  document.getElementById('addQ').click();

  on('click', '#saveSurvey', (e)=>{
    e.preventDefault();
    const code = codeGen();
    const data = { code, title:sTitle.value.trim()||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è', desc:sDesc.value.trim(), questions: JSON.parse(JSON.stringify(state.questions)), createdAt: new Date().toISOString(), owner: (auth.currentUser?.uid||'anon') };
    surveys[code] = data; save(LS_SURVEYS, surveys);
    responses[code] = responses[code]||[]; save(LS_RESP, responses);
    codeOut.textContent = code; createdBlock.classList.remove('hide');
    copyLink.onclick = async ()=>{
      const link = location.origin+location.pathname+`?take=${code}`;
      await navigator.clipboard.writeText(link);
      copyLink.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'; setTimeout(()=>copyLink.textContent='–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É',1200);
    };
  });

  // ===== TAKE SURVEY =====
  const takeFormWrap = document.getElementById('takeFormWrap');
  function renderTake(code){
    const s = surveys[code];
    if(!s){ takeFormWrap.classList.add('hide'); alert('–û–ø—Ä–æ—Å —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
    takeFormWrap.classList.remove('hide');
    takeFormWrap.innerHTML = `<div class="row" style="justify-content:space-between"><div><div class="h">${s.title}</div><div class="muted">${s.desc||''}</div></div><span class="pill">–ö–æ–¥: <span class="kbd" style="margin-left:6px">${code}</span></span></div>`;
    const form = document.createElement('form');
    form.className='grid';
    const vals = {};
    s.questions.forEach(q=>{
      const block=document.createElement('div');
      block.innerHTML = `<div class="muted">${q.text} ${q.required?'<span style="color:#ffb4d6">*</span>':''}</div>`;
      if(q.type==='short_text'){
        const i=document.createElement('input'); i.className='input'; i.placeholder='–í–∞—à –æ—Ç–≤–µ—Ç'; i.oninput=e=>vals[q.id]=e.target.value; block.appendChild(i);
      } else if(q.type==='number'){
        const i=document.createElement('input'); i.type='number'; i.className='input'; i.oninput=e=>vals[q.id]=e.target.value===''?"":Number(e.target.value); block.appendChild(i);
      } else if(q.type==='single'){
        const wrap=document.createElement('div'); wrap.className='row';
        (q.options||[]).forEach(opt=>{ const b=document.createElement('button'); b.type='button'; b.className='btn'; b.textContent=opt; b.onclick=()=>{ vals[q.id]=opt; [...wrap.children].forEach(x=>x.classList.remove('primary')); b.classList.add('primary'); }; wrap.appendChild(b); });
        block.appendChild(wrap);
      } else if(q.type==='multi'){
        const wrap=document.createElement('div'); wrap.className='row'; const arr=[]; vals[q.id]=arr;
        (q.options||[]).forEach(opt=>{ const b=document.createElement('button'); b.type='button'; b.className='btn'; b.textContent=opt; b.onclick=()=>{ const i=arr.indexOf(opt); if(i>=0){arr.splice(i,1); b.classList.remove('primary');} else {arr.push(opt); b.classList.add('primary');} }; wrap.appendChild(b); });
        block.appendChild(wrap);
      }
      form.appendChild(block);
    });
    const submit=document.createElement('button'); submit.className='btn primary block'; submit.textContent='–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã'; submit.type='submit'; form.appendChild(submit);
    form.onsubmit=(e)=>{
      e.preventDefault();
      for(const q of s.questions){
        const v = vals[q.id];
        if(!q.required) continue;
        if(q.type==='multi'){ if(!Array.isArray(v) || v.length===0) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã.'); }
        else if(v===undefined || v==='') return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã.');
      }
      const by = (auth.currentUser?.displayName||auth.currentUser?.email||auth.currentUser?.uid||'anon');
      const rec = { by, at: new Date().toISOString(), answers: vals };
      responses[code] = responses[code]||[]; responses[code].push(rec); save(LS_RESP, responses);
      alert('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!'); takeFormWrap.classList.add('hide');
    };
    takeFormWrap.appendChild(form);
  }
  on('click', '#loadSurvey', (e)=>{ e.preventDefault(); const c=document.getElementById('takeCode').value.trim().toUpperCase(); renderTake(c); });

  // URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  if(url.searchParams.get('take')){ document.getElementById('takeCode').value = url.searchParams.get('take').toUpperCase(); setTab('take'); }
  if(url.searchParams.get('results')){ document.getElementById('resCode').value = url.searchParams.get('results').toUpperCase(); setTab('results'); }

  // ===== RESULTS =====
  const resTableWrap = document.getElementById('resTableWrap');
  function renderResults(code){
    const s = surveys[code];
    const rows = responses[code]||[];
    if(!s){ resTableWrap.classList.add('hide'); return alert('–û–ø—Ä–æ—Å —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω'); }
    resTableWrap.classList.remove('hide');
    let html = `<div class="row" style="justify-content:space-between"><div><div class="h">${s.title}</div><div class="muted">—Å–æ–∑–¥–∞–Ω: ${new Date(s.createdAt).toLocaleString()}</div></div><span class="pill">–ö–æ–¥: <span class="kbd" style="margin-left:6px">${code}</span></span></div>`;
    html += '<div style="overflow:auto;margin-top:10px"><table><thead><tr><th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th>–í—Ä–µ–º—è</th>' + s.questions.map(q=>`<th>${q.text}</th>`).join('') + '</tr></thead><tbody>';
    if(rows.length===0){ html += `<tr><td colspan="${2+s.questions.length}" class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤</td></tr>`; }
    rows.forEach(r=>{
      html += `<tr><td>${r.by||''}</td><td>${new Date(r.at).toLocaleString()}</td>` + s.questions.map(q=>{
        const v=r.answers[q.id]; return `<td>${Array.isArray(v)?v.join(', '):(v??'')}</td>`;
      }).join('') + '</tr>';
    });
    html += '</tbody></table></div>';
    html += '<div class="right" style="margin-top:10px"><button id="csvBtn" class="btn">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç CSV</button></div>';
    resTableWrap.innerHTML = html;

    document.getElementById('csvBtn').onclick = ()=>{
      const headers = ['by','at',...s.questions.map(q=>q.text.replaceAll(',',' '))];
      const lines = [headers.join(',')];
      rows.forEach(r=>{ lines.push([r.by,r.at,...s.questions.map(q=>{ const v=r.answers[q.id]; return Array.isArray(v)?`"${v.join('; ')}"`:(v??''); })].join(',')); });
      const blob = new Blob(["\uFEFF"+lines.join('\n')],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`survey_${code}_results.csv`; a.click();
    };
  }
  on('click', '#loadResults', (e)=>{ e.preventDefault(); const c=document.getElementById('resCode').value.trim().toUpperCase(); renderResults(c); });

  // ===== DEBUG TESTS =====
  if(dbg){
    const DEMO_CODE = 'DEMO01';
    on('click', '#dbgMakeDemo', ()=>{
      const data = {
        code: DEMO_CODE,
        title: '–î–µ–º–æ –æ–ø—Ä–æ—Å',
        desc: '–ü—Ä–æ–≤–µ—Ä–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ CSV',
        createdAt: new Date().toISOString(),
        owner: 'tester',
        questions: [
          { id:'q1', type:'short_text', text:'–ò–º—è', required:true },
          { id:'q2', type:'number', text:'–í–æ–∑—Ä–∞—Å—Ç', required:false },
          { id:'q3', type:'single', text:'–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç', required:true, options:['–ö—Ä–∞—Å–Ω—ã–π','–°–∏–Ω–∏–π','–ó–µ–ª—ë–Ω—ã–π'] },
          { id:'q4', type:'multi', text:'–ò–Ω—Ç–µ—Ä–µ—Å—ã', required:false, options:['–°–ø–æ—Ä—Ç','–ú—É–∑—ã–∫–∞','IT'] }
        ]
      };
      surveys[DEMO_CODE] = data; save(LS_SURVEYS, surveys);
      alert('–î–µ–º–æ-–æ–ø—Ä–æ—Å —Å–æ–∑–¥–∞–Ω: '+DEMO_CODE);
    });

    on('click', '#dbgAddAnswers', ()=>{
      responses[DEMO_CODE] = responses[DEMO_CODE]||[];
      responses[DEMO_CODE].push({ by:'user1', at:new Date().toISOString(), answers:{ q1:'–ê–ª–µ–∫—Å–µ–π', q2:30, q3:'–°–∏–Ω–∏–π', q4:['–ú—É–∑—ã–∫–∞','IT'] } });
      responses[DEMO_CODE].push({ by:'user2', at:new Date().toISOString(), answers:{ q1:'–ò—Ä–∏–Ω–∞', q2:'', q3:'–ö—Ä–∞—Å–Ω—ã–π', q4:['–°–ø–æ—Ä—Ç'] } });
      save(LS_RESP, responses);
      alert('–î–æ–±–∞–≤–ª–µ–Ω–æ 2 –æ—Ç–≤–µ—Ç–∞ –¥–ª—è '+DEMO_CODE);
    });

    on('click', '#dbgOpenResults', ()=>{
      document.getElementById('resCode').value = DEMO_CODE;
      setTab('results');
      renderResults(DEMO_CODE);
    });
  }

  // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –≤–∫–ª–∞–¥–∫–∞
  setTab('create');
  console.log('[SurveyFlow] boot done');
</script>
</body>
</html>
